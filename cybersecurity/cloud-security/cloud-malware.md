# Cloud Malware

## Scopo

Questa guida copre minacce malware specifiche per ambienti cloud, inclusi cryptominers, backdoor in Lambda/Functions, e tecniche di persistenza cloud-native.

## Prerequisiti

- Conoscenza architetture cloud
- Accesso all'ambiente per analisi
- Tool forensics
- **Autorizzazione per investigation**

---

## Vettori di Attacco Cloud

### Entry Points Comuni

```
1. Credenziali compromesse
2. Misconfigurazioni (S3/Blob pubblici)
3. Vulnerabilità applicative (SSRF, RCE)
4. Supply chain (container images, dependencies)
5. Insider threats
```

### Obiettivi Malware

```
- Cryptomining (risorse compute)
- Data exfiltration
- Ransomware
- Botnet/C2
- Lateral movement
```

---

## Cryptominers

### Rilevamento

```bash
# Alto utilizzo CPU
# AWS CloudWatch
aws cloudwatch get-metric-statistics \
    --namespace AWS/EC2 \
    --metric-name CPUUtilization \
    --dimensions Name=InstanceId,Value=i-xxx \
    --start-time 2024-01-01T00:00:00Z \
    --end-time 2024-01-02T00:00:00Z \
    --period 3600 \
    --statistics Average

# Processi sospetti
ps aux | grep -E "xmrig|minerd|cgminer|cpuminer"

# Connessioni a mining pool
netstat -an | grep -E ":3333|:4444|:8888"
```

### Indicatori

```
- CPU > 90% costante
- Processi: xmrig, minerd, kdevtmpfsi
- Connessioni a pool: *.xmr.*, *.minexmr.*
- Modifica crontab
- Processi sotto user www-data o simili
```

### Container Mining

```bash
# Immagini malevole
docker images | grep -v "official"

# Container sospetti
docker ps --format "table {{.ID}}\t{{.Image}}\t{{.Command}}"

# Inspect
docker exec CONTAINER ps aux
docker exec CONTAINER cat /etc/crontab
```

---

## Backdoor Serverless

### Lambda Backdoor

```python
# Esempio backdoor in Lambda
import subprocess
import base64

def lambda_handler(event, context):
    if 'cmd' in event:
        result = subprocess.check_output(event['cmd'], shell=True)
        return {'body': base64.b64encode(result).decode()}
    
    # Funzione legittima continua...
```

### Rilevamento

```bash
# Lista Lambda sospette
aws lambda list-functions --query "Functions[*].{Name:FunctionName,Runtime:Runtime,Modified:LastModified}"

# Verifica codice
aws lambda get-function --function-name FUNC --query "Code.Location"

# Download e analisi
wget -O function.zip "PRESIGNED_URL"
unzip function.zip
grep -r "subprocess\|exec\|eval\|system" .
```

### Azure Functions

```bash
# Lista functions
az functionapp list

# Verifica deployment
az functionapp deployment source show --name APP --resource-group RG
```

---

## Persistenza Cloud

### IAM Backdoor

```bash
# Nuovo utente nascosto
aws iam list-users --query "Users[*].{Name:UserName,Created:CreateDate}"

# Access keys per utenti esistenti
aws iam list-access-keys --user-name USER

# Nuovi ruoli
aws iam list-roles --query "Roles[*].{Name:RoleName,Created:CreateDate}"
```

### Lambda Persistence

```bash
# Lambda invoke tramite CloudWatch Events
aws events list-rules
aws events list-targets-by-rule --rule RULE_NAME

# Trigger nascosti
aws lambda list-event-source-mappings
```

### EC2 Persistence

```bash
# Launch templates modificati
aws ec2 describe-launch-templates

# AMI personalizzate
aws ec2 describe-images --owners self

# User data malevolo
aws ec2 describe-instance-attribute --instance-id ID --attribute userData
```

---

## Container Threats

### Immagini Malevole

```bash
# Verifica image
docker history IMAGE

# Scan vulnerabilità
trivy image IMAGE

# Verifica firma
docker trust inspect IMAGE
```

### Escape Attempts

```bash
# Container privilegiato
docker inspect CONTAINER | grep -i privileged

# Mounted sensitive paths
docker inspect CONTAINER | grep -A5 Mounts

# Capabilities
docker inspect CONTAINER | grep -A20 CapAdd
```

### Kubernetes

```bash
# Pod sospetti
kubectl get pods --all-namespaces -o wide

# Secrets acceduti
kubectl auth can-i --list

# RBAC eccessivo
kubectl get clusterrolebindings
```

---

## Data Exfiltration

### S3 Exfil

```bash
# Bucket access logs
aws s3api get-bucket-logging --bucket BUCKET

# CloudTrail data events
aws cloudtrail lookup-events \
    --lookup-attributes AttributeKey=EventName,AttributeValue=GetObject
```

### DNS Exfiltration

```bash
# Query DNS anomale
# VPC Flow Logs per traffico DNS

# Route53 query logs
aws logs filter-log-events \
    --log-group-name /aws/route53/query \
    --filter-pattern "TXT"
```

---

## Detection Tools

### AWS GuardDuty

```bash
# Findings
aws guardduty list-findings --detector-id DETECTOR_ID

# Dettagli finding
aws guardduty get-findings --detector-id DETECTOR --finding-ids ID
```

### Finding Types

```
- CryptoCurrency:EC2/BitcoinTool.B
- Backdoor:EC2/Spambot
- UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration
- Recon:EC2/PortProbeUnprotectedPort
```

### AWS Security Hub

```bash
# Findings aggregati
aws securityhub get-findings --filters '{"ProductName": [{"Value": "GuardDuty"}]}'
```

### Azure Defender

```bash
# Alerts
az security alert list

# Recommendations
az security assessment list
```

---

## Response

### Isolamento

```bash
# Rimuovi da SG
aws ec2 modify-instance-attribute --instance-id ID --groups sg-isolated

# Revoca credenziali
aws iam delete-access-key --user-name USER --access-key-id KEY

# Disable Lambda
aws lambda put-function-concurrency --function-name FUNC --reserved-concurrent-executions 0
```

### Forensics

```bash
# Snapshot EBS
aws ec2 create-snapshot --volume-id vol-xxx --description "Forensic copy"

# Memory dump (EC2)
# Richiede SSM agent

# Container forensics
docker export CONTAINER > container_forensic.tar
```

### Remediation

```bash
# Terminate compromised instance
aws ec2 terminate-instances --instance-ids ID

# Delete backdoor user
aws iam delete-user --user-name BACKDOOR_USER

# Rotate all credentials
aws iam update-access-key --access-key-id KEY --status Inactive --user-name USER
```

---

## Prevenzione

### AWS

```
- GuardDuty attivo
- CloudTrail logging
- Config rules
- IMDSv2 enforced
- VPC Flow Logs
```

### Containers

```
- Image scanning (ECR, ACR, GCR)
- Pod Security Policies/Standards
- Falco per runtime detection
- Network policies
```

### Serverless

```
- Least privilege IAM
- Code signing
- VPC integration
- Layer verification
```

---

## Best Practices

- **Monitoring**: Logging completo attivo
- **Detection**: Alerting su anomalie
- **Response**: Runbook preparati
- **Prevention**: Security by design
- **Training**: Team awareness

## Riferimenti

- [AWS GuardDuty](https://docs.aws.amazon.com/guardduty/)
- [Azure Defender](https://docs.microsoft.com/azure/defender-for-cloud/)
- [Falco](https://falco.org/)
- [MITRE ATT&CK Cloud](https://attack.mitre.org/matrices/enterprise/cloud/)
